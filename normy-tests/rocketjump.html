<!DOCTYPE html>
<html>
    <head>
        <title>Infinite Run</title>
        <script src="http://code.createjs.com/createjs-2013.05.14.min.js"></script>
        <script src="scripts/jquery-2.0.2.min.js"></script>
        <script src="scripts/underscore-min.js"></script>
        
        <script>
          var stage, player;
          var keymaps = new Array();
          var dx = 0, dy = 0;
          var pressed = {};
          
          var rocketDir = {};
          var rocket;
          var rocketActive = false;
          
          var explosion;
          var explosionTimer = 0.0;
          
          var bootsFraction = 1.0;
          var rocketFraction = 1.0;
          
          function HFractionBar(x, y, width, height, colorFilled, colorEmpty) {
            this.lbar = new createjs.Shape();
            this.rbar = new createjs.Shape();
            this.lbar.x = x; this.lbar.y = y;
            this.rbar.x = x+width; this.rbar.y = y;
            this.width = width;
            this.height = height;
            this.colorFilled = colorFilled;
            this.colorEmpty = colorEmpty;
            this.update = function(fraction) {
              this.lbar.graphics.c().f(this.colorFilled).r(0,0,this.width*fraction,this.height);
              this.rbar.graphics.c().f(this.colorEmpty).r(0,0,this.width*(fraction-1),this.height);
            }
            stage.addChild(this.lbar);
            stage.addChild(this.rbar);
            _.bindAll(this);
          }
          
          var bootsBar, rocketBar;
          
          var calibStage = {},
              calibPage = {},
              cal = {};
          // note that easeljs stage events won't trigger when leaving the canvas,
          // even when you enable them. Hence the workaround
          function calibrateMouseStage(event) {
            calibStage.x = event.stageX;
            calibStage.y = event.stageY;
          }
          function calibrateMouseStageUp(event) {
            cal.x = calibPage.x - calibStage.x;
            cal.y = calibPage.y - calibStage.y;
            $(document).off("mousedown",calibrateMousePage);
            stage.removeEventListener("stagemousedown",calibrateMouseStage);
            stage.removeEventListener("stagemouseup",calibrateMouseStageUp);
            $(document).on("mousedown",shootBazooka);
          }
          function calibrateMousePage(event) {
            calibPage.x = event.pageX;
            calibPage.y = event.pageY;
          }
          
          function shootBazooka(event) {
            if (rocketFraction >= 1.0 ) {
              var pt = stage.globalToLocal(event.pageX-cal.x, event.pageY-cal.y);
              //console.log(pt.x + ", " + pt.y);
              
              var dir = { x: player.x - pt.x, y: player.y+40 - pt.y };
              var length2 = dir.x*dir.x+dir.y*dir.y;
              if (length2>25) {
                var length = Math.sqrt(length2);
                rocketDir.x = -dir.x / length;
                rocketDir.y = -dir.y / length;
                rocket.x = player.x;
                rocket.y = player.y+40;
                rocketActive = true;
                // change this so you move more if you're not on the ground
                player.vx -= rocketDir.x * 30;
                player.vy -= rocketDir.y * 30;
                stage.addChild(rocket);
                rocketFraction = 0.0;
              }
            }
          }
          
          function init() {
            stage = new createjs.Stage("demoCanvas");
            keymaps[87] = keymaps[38] = "up";
            keymaps[65] = keymaps[37] = "left";
            keymaps[83] = keymaps[40] = "down";
            keymaps[68] = keymaps[39] = "right";
            
            bootsBar = new HFractionBar(6,405,150,10,"blue","darkblue");
            rocketBar = new HFractionBar(6,394,150,10,"#00ff00","darkgreen");
            
            $(document).on('keydown',function(e) {
              if (keymaps[e.which]) {
                var cmp = keymaps[e.which];
                pressed[cmp] = true;
                
                if (cmp === "up") {
                  dy = 1;
                } else if (cmp === "down") {
                  dy = -1;
                } else if (cmp === "left") {
                  dx = -1;
                } else if (cmp === "right") {
                  dx = 1;
                }
              }
            });
            $(document).on('keyup',function(e) {
              if (keymaps[e.which]) {
                var cmp = keymaps[e.which];
                pressed[cmp] = false;
                
                if (cmp === "up") {
                  dy = pressed["down"] ? -1 : 0;
                } else if (cmp === "down") {
                  dy = pressed["up"] ? 1 : 0;
                } else if (cmp === "left") {
                  dx = pressed["right"] ? 1 : 0;
                } else if (cmp === "right") {
                  dx = pressed["left"] ? -1 : 0;
                }
              }
            });

            player = new createjs.Shape();
            player.graphics.beginFill("green").rect(-25,0,50,60);
            player.cache(-25,0,50,60);
            player.x = 240; player.y = 0;
            player.vx = 0; player.vy = 0;
            stage.setTransform(0,420,1,-1);
            stage.addChild(player);
            
            rocket = new createjs.Shape();
            rocket.graphics.beginFill("black").drawCircle(0,0,4);
            rocket.cache(-4,-4,8,8);
            rocket.x = 0; rocket.y = 0;
            
            explosion = new createjs.Shape();
            explosion.graphics.beginFill("orange").drawCircle(0,0,30);
            explosion.cache(-30,-30,60,60);
            
            alert("Click once in the game area to calibrate the mouse (i.e. Norman was too lazy to do some math");
            
            $(document).on("mousedown",calibrateMousePage);
            stage.addEventListener("stagemousedown",calibrateMouseStage);
            stage.addEventListener("stagemouseup",calibrateMouseStageUp);

            createjs.Ticker.addEventListener("tick", tick);
            createjs.Ticker.setFPS(60);
          }

          function tick(event) {
            var dt = (event.delta)/1000;
            var diagFactor = (dx*dx+dy*dy > 1) ? Math.sqrt(2*2+5*5)/5 : 1;
            var v = 300;
            
            // I'll make this integration better at some other point
            player.x = player.x + player.vx * dt;
            player.y = player.y + player.vy * dt;
            
            player.vx -= player.vx * dt;
            player.vy -= player.vy * dt;
            
            player.vy -= 800 * dt;
            
            
            if (dx*dx+dy*dy > 0 && bootsFraction > 0.0) {
              player.vx += dx * 2*(100 + (bootsFraction * 200)) * dt / diagFactor;
              player.vy += dy * 6*(100 + (bootsFraction * 200)) * dt / diagFactor;
              bootsFraction -= (bootsFraction+1)*dt*2.5;
              if (bootsFraction <= 0.0) {
                bootsFraction = 0.0;
              }
            }
            
            if (rocketActive) {
              rocket.x += rocketDir.x * 600 * dt;
              rocket.y += rocketDir.y * 600 * dt;
            }
            
            if (rocketActive && (rocket.x < 0 || rocket.x >= 640 || rocket.y < 0 || rocket.y >= 420)) {
              rocketActive = false;
              explosion.x = rocket.x;
              explosion.y = rocket.y;
              explosionTimer = 0.15;
              var dist2 = (player.x-rocket.x)*(player.x-rocket.x)+(player.y+30-rocket.y)*(player.y-rocket.y+30);
              player.vx += (player.x-rocket.x) / (dist2 + 100) * 6000;
              player.vy += (player.y+30-rocket.y) / (dist2 + 100) * 6000;
              stage.addChild(explosion);
              stage.removeChild(rocket);
            }
            
            if (explosionTimer > 0.0) {
              explosionTimer -= dt;
              if (explosionTimer <= 0.0) {
                stage.removeChild(explosion);
              }
            }
            
            if (bootsFraction < 1.0) {
              bootsFraction += (1.1-bootsFraction)*dt*2.5;
              if (bootsFraction >= 1.0) {
                bootsFraction = 1.0;
              }
            }
            
            if (rocketFraction < 1.0) {
              rocketFraction += (2-rocketFraction)*dt;
              if (rocketFraction >= 1.0) {
                rocketFraction = 1.0;
              }
            }
            
            if (rocketActive) {
              rocketBar.colorFilled = "red";
            } else {
              rocketBar.colorFilled = "#00ff00";
            }
            
            if (player.y < 0) {
              player.y = 0;
              player.vy = 0;
            }
            
            bootsBar.update(bootsFraction);
            rocketBar.update(rocketFraction);
            
            stage.update(event);
          }
          
        </script>
    </head>
    <body onload="init();">
      <div class="canvasHolder">
        <canvas id="demoCanvas" width="640" height="420" style="border:2px solid;-moz-user-select: -moz-none;-webkit-user-select: none;">Sadness</canvas>
      </div>
    </body>
</html>
