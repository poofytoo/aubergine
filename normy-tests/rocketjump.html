<!DOCTYPE html>
<html>
    <head>
        <title>Infinite Run</title>
        <script src="http://code.createjs.com/createjs-2013.05.14.min.js"></script>
        <script src="scripts/jquery-2.0.2.min.js"></script>
        <script src="scripts/underscore-min.js"></script>
        
        <script>
          var stage, player;
          var keymaps = new Array();
          var dx = 0, dy = 0;
          var pressed = {};
          
          var bootsFraction = 1.0;
          var rocketFraction = 1.0;
          
          function HFractionBar(x, y, width, height, colorFilled, colorEmpty) {
            this.lbar = new createjs.Shape();
            this.rbar = new createjs.Shape();
            this.lbar.x = x; this.lbar.y = y;
            this.rbar.x = x+width; this.rbar.y = y;
            this.width = width;
            this.height = height;
            this.colorFilled = colorFilled;
            this.colorEmpty = colorEmpty;
            this.update = function(fraction) {
              this.lbar.graphics.c().f(this.colorFilled).r(0,0,this.width*fraction,this.height);
              this.rbar.graphics.c().f(this.colorEmpty).r(0,0,this.width*(fraction-1),this.height);
            }
            stage.addChild(this.lbar);
            stage.addChild(this.rbar);
            _.bindAll(this);
          }
          
          var bootsBar, rocketBar;
          
          function init() {
            stage = new createjs.Stage("demoCanvas");
            keymaps[87] = keymaps[38] = "up";
            keymaps[65] = keymaps[37] = "left";
            keymaps[83] = keymaps[40] = "down";
            keymaps[68] = keymaps[39] = "right";
            
            bootsBar = new HFractionBar(6,405,150,10,"blue","darkblue");
            rocketBar = new HFractionBar(6,394,150,10,"#00ff00","darkgreen");
            
            $(document).on('keydown',function(e) {
              if (keymaps[e.which]) {
                var cmp = keymaps[e.which];
                pressed[cmp] = true;
                
                if (cmp === "up") {
                  dy = 1;
                } else if (cmp === "down") {
                  dy = -1;
                } else if (cmp === "left") {
                  dx = -1;
                } else if (cmp === "right") {
                  dx = 1;
                }
              }
            });
            $(document).on('keyup',function(e) {
              if (keymaps[e.which]) {
                var cmp = keymaps[e.which];
                pressed[cmp] = false;
                
                if (cmp === "up") {
                  dy = pressed["down"] ? -1 : 0;
                } else if (cmp === "down") {
                  dy = pressed["up"] ? 1 : 0;
                } else if (cmp === "left") {
                  dx = pressed["right"] ? 1 : 0;
                } else if (cmp === "right") {
                  dx = pressed["left"] ? -1 : 0;
                }
              }
            });

            player = new createjs.Shape();
            player.graphics.beginFill("green").rect(-25,0,50,60);
            player.cache(-25,0,50,60);
            player.x = 240; player.y = 0;
            player.vx = 0; player.vy = 0;
            stage.setTransform(0,420,1,-1);
            stage.addChild(player);

            createjs.Ticker.addEventListener("tick", tick);
            createjs.Ticker.setFPS(60);
          }

          function tick(event) {
            var dt = (event.delta)/1000;
            var diagFactor = (dx*dx+dy*dy > 1) ? Math.sqrt(2*2+5*5)/5 : 1;
            var v = 300;
            
            // I'll make this integration better at some other point
            player.x = player.x + player.vx * dt;
            player.y = player.y + player.vy * dt;
            
            player.vx -= player.vx * dt;
            player.vy -= player.vy * dt;
            
            player.vy -= 800 * dt;
            
            
            if (dx*dx+dy*dy > 0 && bootsFraction > 0.0) {
              player.vx += dx * 2*(100 + (bootsFraction * 200)) * dt / diagFactor;
              player.vy += dy * 5*(100 + (bootsFraction * 200)) * dt / diagFactor;
              bootsFraction -= (bootsFraction+1)*dt*2.5;
              if (bootsFraction <= 0.0) {
                bootsFraction = 0.0;
              }
            }
            
            
            
            if (bootsFraction < 1.0) {
              bootsFraction += (1.1-bootsFraction)*dt*2.5;
              if (bootsFraction >= 1.0) {
                bootsFraction = 1.0;
              }
            }
            
            if (player.y < 0) {
              player.y = 0;
              player.vy = 0;
            }
            
            bootsBar.update(bootsFraction);
            rocketBar.update(rocketFraction);
            
            stage.update(event);
          }
          
        </script>
    </head>
    <body onload="init();">
      <div class="canvasHolder">
        <canvas id="demoCanvas" width="640" height="420" style="border:2px solid;">Sadness</canvas>
      </div>
    </body>
</html>
